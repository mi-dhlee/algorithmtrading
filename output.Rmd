---
title: "R Notebook"
output: html_notebook
---

R과 이베스트 API를 이용한 알고리즘 트레이딩 예제이다. 다음 코드는 R 32비트 버전에서 실행 할 수 있으며 이베스트 API, statconnDcom이 사전에 설치되어 있어야 한다. 먼저 로그인 과정부터 살펴보자.

```{r}
rm(list=ls(all=TRUE))

library(rcom)

obj=comCreateObject("XA_Session.XASession")
objQuery.t8430=comCreateObject("XA_DataSet.XAQuery")
objQuery.t4201=comCreateObject("XA_DataSet.XAQuery")

#######################
##Log In
#######################
comInvoke(obj,"DisconnectServer")
comInvoke(obj,"ConnectServer","demo.etrade.co.kr",20001)

ID="your ID"
PW1="your pwd"

Login=comInvoke(obj,"Login",ID,PW1,"",0,"False")

repeat {
	if(comInvoke(obj,"GetClientIP")=="") {
		Sys.sleep(1)
	} else {
		break
	}
}

Sys.sleep(5)

```

이베스트의 com object를 import하기 위해 rcom 라이브러리를 사용한다. 로그인 시 오류가 발생 할 수 있으므로 repeat 문을 통해서 오류처리를 하도록 한다.

다음은 주가를 전송 받기 위해 코스피 전체 종목의 코드를 불러오는 코드이다. 이베스트 com 버전의 API는 각 tr마다 과부하를 줄이기 위해 허용하는 시간이 있다. 중간 중간에 sleep을 걸어준 부분에 유의해서 보도록 하자.  

```{r}
#########################
##Get Code
#########################
comInvoke(objQuery.t8430,"LoadFromResFile","C:/eBEST/xingAPI/Res/t8430.res")
comInvoke(objQuery.t8430,"SetFieldData","t8430InBlock", "gubun", 0, 1) 

repeat {
	comRqst=comInvoke(objQuery.t8430,"Request","False")

	if(comRqst<0) {
		Sys.sleep(2)
	} else {
		break
	}
}

Sys.sleep(2)

LoopEnd=comInvoke(objQuery.t8430,"GetBlockCount","t8430OutBlock")

repeat {
	LoopEnd=comInvoke(objQuery.t8430,"GetBlockCount","t8430OutBlock")

	if(LoopEnd=="" | LoopEnd==0) {
		Sys.sleep(2)

		LoopEnd=comInvoke(objQuery.t8430,"GetBlockCount","t8430OutBlock")
	} else {
		break
	}
}

Sys.sleep(3)

LoopEnd=as.numeric(LoopEnd)
LoopEnd=LoopEnd-1

CodeFunc=function(i) {
	Code=comInvoke(objQuery.t8430,"GetFieldData","t8430OutBlock", "shcode", i)

	repeat {
		if(Code=="") {
			Sys.sleep(1)

			Code=comInvoke(objQuery.t8430,"GetFieldData","t8430OutBlock", "shcode", i)
		} else {
			break
		}
	}

	return(Code)
}

Code=as.vector(unlist(lapply(0:LoopEnd,CodeFunc)))

```

받아온 코스피 종목 코드의 일부는 아래와 같다.

```{R}
head(Code)
```

받아온 코스피 종목 코드를 이용하여 아래와 같이 시가, 고가, 저가, 종가, 거래량, 수정비율을 받아온다. 본 예제에서는 모의투자 계좌에 접속하였기 때문에 t4201 tr을 사용하지만 실투자 계좌에 접속하면 t4201 보다 좋은 tr이 있으니 사용하도록 한다. 

특히 주식의 경우 유상증자등의 이벤트 발생 시 주가가 이전 주가와 상당히 다르게 된다. 따라서 수정비율을 미리 저장해 놓음으로써 이전 주가를 보정하여 분석에 사용하도록 한다. 

본 예제에서는 현재기준 500일 전까지의 데이터만 받아온다. 더 이전의 데이터가 필요하다면 API 레퍼런스를 통해 연속조회를 하도록 한다.

```{r}
#########################
##Get Recent Data : Monthly
#########################
PastPriceFunc=function(j) {
	Date=comInvoke(objQuery.t4201,"GetFieldData","t4201OutBlock1", "date",j+1)
	Open=comInvoke(objQuery.t4201,"GetFieldData","t4201OutBlock1", "open",j+1)
	High=comInvoke(objQuery.t4201,"GetFieldData","t4201OutBlock1", "high",j+1)
	Low=comInvoke(objQuery.t4201,"GetFieldData","t4201OutBlock1", "low",j+1)
	Close=comInvoke(objQuery.t4201,"GetFieldData","t4201OutBlock1", "close",j+1)
	Volume=comInvoke(objQuery.t4201,"GetFieldData","t4201OutBlock1", "jdiff_vol",j+1)
	Rate=comInvoke(objQuery.t4201,"GetFieldData","t4201OutBlock1", "rate",j+1)
	
	DoCnt=0

	repeat {
		DoCnt=DoCnt+1

		if(Date=="" | Open=="" | High=="" | Low=="" | Close=="") {
			if(DoCnt>=10) {
				break
			}

			Sys.sleep(1)

			Date=comInvoke(objQuery.t4201,"GetFieldData","t4201OutBlock1", "date",j+1)
			Open=comInvoke(objQuery.t4201,"GetFieldData","t4201OutBlock1", "open",j+1)
			High=comInvoke(objQuery.t4201,"GetFieldData","t4201OutBlock1", "high",j+1)
			Low=comInvoke(objQuery.t4201,"GetFieldData","t4201OutBlock1", "low",j+1)
			Close=comInvoke(objQuery.t4201,"GetFieldData","t4201OutBlock1", "close",j+1)
			Volume=comInvoke(objQuery.t4201,"GetFieldData","t4201OutBlock1", "jdiff_vol",j+1)
			Rate=comInvoke(objQuery.t4201,"GetFieldData","t4201OutBlock1", "rate",j+1)
		} else {
			break
		}
	}

	if(DoCnt>=10) {
		Data=matrix(rep(NA,7),nrow=1)		
	} else {	
		Data=cbind(Date,Open,High,Low,Close,Volume,Rate)
		Data=matrix(as.numeric(Data),nrow=1)
	}

	return(Data)
}

Cnt=500
Sdate=gsub("-","",Sys.Date()-Cnt)
SaveDataPath="C:/Git/Rds/"
SavedPriceList=list.files(paste(SaveDataPath,"Price/",sep=""))
SavedPriceList=gsub(".rds","",SavedPriceList)

CodeF=Code[sample(1:length(Code),50)]

for(i in c(1:length(CodeF))) {
	if(is.na(match(CodeF[i],SavedPriceList))==TRUE) {
		comInvoke(objQuery.t4201,"LoadFromResFile","C:/eBEST/xingAPI/Res/t4201.res")

		comInvoke(objQuery.t4201,"SetFieldData","t4201InBlock", "shcode", 0, CodeF[i]) 
		comInvoke(objQuery.t4201,"SetFieldData","t4201InBlock", "gubun", 0, 2) 
		comInvoke(objQuery.t4201,"SetFieldData","t4201InBlock", "ncnt", 0, "")
		comInvoke(objQuery.t4201,"SetFieldData","t4201InBlock", "qrycnt", 0, "")
		comInvoke(objQuery.t4201,"SetFieldData","t4201InBlock", "tdgb", 0, "0")	
		comInvoke(objQuery.t4201,"SetFieldData","t4201InBlock", "sdate", 0, Sdate)
		comInvoke(objQuery.t4201,"SetFieldData","t4201InBlock", "edate", 0, "99999999")
		comInvoke(objQuery.t4201,"SetFieldData","t4201InBlock", "cts_date", 0, "")
		comInvoke(objQuery.t4201,"SetFieldData","t4201InBlock", "cts_time", 0, "")
		comInvoke(objQuery.t4201,"SetFieldData","t4201InBlock", "cts_daygb", 0, "")
		
		Sys.sleep(3)
		
		comInvoke(objQuery.t4201,"Request","False")
		
		Sys.sleep(2)
			
		LoopEnd=comInvoke(objQuery.t4201,"GetBlockCount","t4201OutBlock1")
		DoCnt=0

		repeat {
			DoCnt=DoCnt+1

			if(LoopEnd=="" | LoopEnd==0) {
				if(DoCnt>=10) {
					break
				}

				Sys.sleep(2)
				
				LoopEnd=comInvoke(objQuery.t4201,"GetBlockCount","t4201OutBlock1")
			} else {
				break
			}
		}

		if(DoCnt>=10) {
			message(sprintf("error!! %s will be passed!!",CodeF[i]))

			next
		} else {
			LoopEnd=as.numeric(LoopEnd)
			LoopEnd=LoopEnd-1
	
			PriceData=do.call(rbind,lapply(0:(LoopEnd-1),PastPriceFunc))
			PriceData=matrix(PriceData,ncol=7)
			colnames(PriceData)=c(CodeF[i],"Open","High","Low","Close","Volume","Rate")
		
			saveRDS(PriceData,paste(SaveDataPath,"Price/",CodeF[i],".rds",sep=""))
			message(sprintf("%d of %d [%s : done]",i,length(CodeF),CodeF[i]))	
		}
	} else {
		message(sprintf("[%s exist]",CodeF[i]))
	}
}
```

저장 된 주가 데이터는 아래와 같다.

```{R}
head(PriceData)
```

다음으로 주가 예측에 사용하기 위해서 KOSIS 통계정보("http://kosis.kr/openapi/index/index.jsp")를 통해 통계데이터를 받아오도록한다. 각 API 사용 방법에 대한 상세한 사항은 홈페이지를 참고하다록 하자. 본 예제에서는 JSON형식으로 1개의 데이터를 요청하는 예제를 담았다.

```{R}
library(rjson)
library(RJSONIO)

###################
##Get Statistic Data
###################
apiKey="your API Key"
userStatsId="your ID"
apiRkey="your api related value"
Cnt=24

URL=paste("http://kosis.kr/openapi/statisticsData.do?method=getList&apiKey=",
	apiKey,
	"=&format=json&jsonVD=Y&userStatsId=",
	userStatsId,
	"/301/DT_042Y001/2/1/",apiRkey,"&prdSe=M&newEstPrdCnt=",
	Cnt)
	
Data=fromJSON(paste(readLines(URL,encoding="UTF-8"), collapse=""))

DatList=lapply(Data,function(x) {
	aDat=matrix(cbind(x["PRD_DE"],x["DT"]),ncol=2)	
})

wdDat=do.call(rbind,DatList)
saveRDS(wdDat,"C:/Git/Rds/Stat/wd.rds")
```

아웃풋은 아래와 같다.

```{R}
head(wdDat)
```

KOSIS에는 수 많은 통계 데이터가 존재하므로 분석가의 목적에 맞게 데이터를 받아서 분석해보자.

다음으로 수집된 데이터를 바탕으로 본격적으로 분석하도록 한다. 우선 데이터 클린징을 하자.

```{R}
library(fPortfolio)
library(e1071)
library(TTR)
library(PerformanceAnalytics)
library(quantmod)
library(parallel)


###################
##Reading Price
###################
TotalDataPath="C:/Git/Rds/"

rpList=list.files(paste(TotalDataPath,"Price/",sep=""))
tc=gsub(".rds","",rpList)

PriceList=as.list(rep(NA,length(tc)))

for(i in c(1:length(tc))) {
	prices=readRDS(paste(TotalDataPath,"Price/",rpList[i],sep=""))

	if("try-error" %in% class(prices)) {
		PriceList[[i]]=NA
	} else {
		timeM=as.character(prices[,tc[i]])
		rownames(prices)=timeM
		Preprices=prices[,2:ncol(prices)]
		prices=matrix(Preprices,ncol=6,dimnames=list(prices[,1],colnames(prices)[-1]))
		
		Dnames=order(rownames(prices))
		
		prices=matrix(prices[Dnames,],ncol=6,
			dimnames=list(rownames(prices)[Dnames],colnames(prices)))

		PriceList[[i]]=as.timeSeries(prices)		
	}
}


###################
##Cleansing Price
###################
n=length(PriceList)
Prices=as.list(rep(NA,n))

for(i in c(1:n)) {
	naMatch=PriceList[[i]][is.na(PriceList[[i]])]

	if(is.null(naMatch)==TRUE) {
		DataSet=PriceList[[i]]
		DataSet[is.na(DataSet)]=0

		DataSetDate=as.numeric(as.Date(rownames(DataSet)))
		DateCheck=which(diff(DataSetDate)>=21)

		if(identical(integer(0),DateCheck)==TRUE & length(DataSetDate)>=21) {		
			DSmat=matrix(DataSet,ncol=ncol(DataSet),
				dimnames=list(rownames(DataSet),colnames(DataSet)))
				
			dsr=as.numeric(DSmat[,"Rate"])
			A=which(dsr!=0); DoA=1;
			
			if(identical(integer(0),A)==FALSE) {
				if(length(A)==1) {
					if(A==1) {
						DSmat[1,"Rate"]=0
						
						DoA=0
					} else if(A==nrow(DSmat)) {
						B=as.numeric(DSmat[nrow(DSmat),"Rate"])
						
						DSmat[1:(nrow(DSmat)-1),"Rate"]=B
						DSmat[nrow(DSmat),"Rate"]=0
						
						DoA=0
					}
				}
				
				if(DoA==1) {
					for(j in c(1:length(A))) {
						if(j==1) {
							B=c(1:(A[j]-1))							
						} else if(j!=length(A)) {
							B=c((A[j-1]+1):(A[j]-1))							
						}
				
						DSmat[B,"Rate"]=DSmat[A[j],"Rate"]
					}
					
					DSmat[A,"Rate"]=0
				}
				
				for(j in c(1:4)) {
					DSmat[,j]=floor(DSmat[,j]*(1+DSmat[,"Rate"]/100))
				}
			}
			
			DataSet=as.timeSeries(DSmat[,1:5])
			
			Close=DataSet[,c("Close")]
			Volume=DataSet[,c("Volume")]

			mClose=mean(Close[(nrow(DataSet)-20):nrow(DataSet),])
			mVolume=mean(Volume[(nrow(DataSet)-20):nrow(DataSet),])

			if(mVolume>=10000 & mClose*mVolume>=10000*10000) {
				Prices[[i]]=list(name=tc[i],price=DataSet)			
			} else {
				Prices[[i]]=NA
			}
		}
	}
}

Prices=Prices[is.na(Prices)==FALSE]

nyName=do.call(c,lapply(Prices,function(x) { return(x$name) }))

nyOpen=do.call(cbind,lapply(Prices,function(x) { return(x$price[,"Open"]) }))
nyOpen=nyOpen[rowSums(is.na(nyOpen))==0,]
colnames(nyOpen)=nyName

nyHigh=do.call(cbind,lapply(Prices,function(x) { return(x$price[,"Close"]) }))
nyHigh=nyHigh[rowSums(is.na(nyHigh))==0,]
colnames(nyHigh)=nyName

nyLow=do.call(cbind,lapply(Prices,function(x) { return(x$price[,"Low"]) }))
nyLow=nyLow[rowSums(is.na(nyLow))==0,]
colnames(nyLow)=nyName

nyClose=do.call(cbind,lapply(Prices,function(x) { return(x$price[,"Close"]) }))
nyClose=nyClose[rowSums(is.na(nyClose))==0,]
colnames(nyClose)=nyName

nyVolume=do.call(cbind,lapply(Prices,function(x) { return(x$price[,"Volume"]) }))
nyVolume=nyVolume[rowSums(is.na(nyVolume))==0,]
colnames(nyVolume)=nyName

return=diff(log(nyClose))*100
return[1,]=0
return=return[,colSums(is.na(return))==0]

n=ncol(return)

```

데이터 클린징 과정에서 수정비율을 반영하였고 최근 20거래일 평균 거래량과 거래대금이 일정 기준 이상인 종목만을 분석대상으로 하였다. 본 예제에서는 단순히 거래량 및 거래대금을 기준으로 유동성이 일정부분 있는 종목만을 분석하지만 좀 더 좋은 예측을 위해서는 기업의 fundamental을 계량화 하여 EPS, BPS, PER, ROE, PBR, 부채비율 등을 조건으로 걸어 분석해야 할 것이다.

분석에 사용될 시고저종, 거래량 및 수익률 데이터가 각 변수로 저장 되었고 그 중 주가 수익률의 일부분은 아래와 같다.

```{R}
head(return)
```

다음으로 저장 된 통계데이터를 로드하여 클린징 한다. 주가는 일별 데이터이고 통계데이터는 월별 데이터으므로 lag를 맞추는 작업도 반드시 해준다. 

```{R}
###################
##Reading Stat
###################
rpList=list.files(paste(TotalDataPath,"Stat/",sep=""))

Sc=gsub(".rds","",rpList)
StatList=as.list(rep(NA,length(Sc)))

Rnames=rownames(return)
Bnames=strsplit(Rnames,"-")
BnVec=unlist(lapply(Bnames,function(x) { paste(c(x[1],x[2]),collapse="") }))

for(i in c(1:length(Sc))) {
	Stats=readRDS(paste(TotalDataPath,"Stat/",rpList[i],sep=""))
	
	Snames=Stats[,1]
	SnVec=rep(NA,length(Snames))
	
	for(j in c(1:length(Snames))) {
		A=which(BnVec==Snames[j])
		
		if(identical(integer(0),A)==FALSE) {
			SnVec[j]=Rnames[max(A)]
		}
	}
	
	Stats[,1]=SnVec
	Stats=matrix(Stats[rowSums(is.na(Stats))==0,],ncol=2)
	
	StDat=matrix(as.numeric(Stats[,2]),ncol=1,dimnames=list(Stats[,1],Sc[i]))
	StatList[[i]]=as.timeSeries(StDat)
}

Stats=do.call(cbind,StatList)
Stats=Stats[rowSums(is.na(Stats))==0,]

```

통계 데이터의 일부는 다음과 같다.

```{R}
head(Stats)
```

다음으로 수집 된 데이터를 변환하여 분석에 사용해 보도록 한다. 여기에서는 기술적 지표 및 통계 데이터의 변화량만을 가지고 주가예측에 사용한다. 

주의해야 할 점은 기술적 지표의 경우 예시에 사용될 수 있을 만큼 계량화 하기 쉽지만 주가를 예측하기 위해서 기술적 지표가 갖는 값 자체 보다는 각 기술적 지표의 의미를 자세히 파악하여 변환시키는 과정이 필수이다. 이 부분은 통계 데이터도 마찬가지이다. 본 예제에서는 방법론 소개가 목적이므로 각 변수의 값을 그대로 사용하였다.

이후에서 SVM을 사용할 것이므로 학습셋과 테스트셋을 분리하도록 한다.

```{R}
###################
##Data Set
###################
df=as.list(rep(NA,n))
dfTest=as.list(rep(NA,n))
dfVdn=as.list(rep(NA,n))

subStat=diff(log(Stats))*100

for(i in c(1:n)) {
	#Technical Indicator
	Kst=as.timeSeries(KST(nyClose[,i],n=c(1,2),nROC=c(1,2),nSig=2)[,2])
	Roc=ROC(nyClose[,i])
	
	FastD=stoch(Roc,nFastK=5,nFastD=20,nSlowD=20,maType=list(list(EMA), list(EMA, wilder=TRUE), list(EMA)))
	StochK=FastD[,c("fastD")]
	StochD=EMA(StochK,n=5)
	Stoch=diff(StochK-StochD)	
	
	Obv=OBV(as.vector(nyClose[,i]),as.vector(nyVolume[,i]))
	Obv=as.timeSeries(matrix(Obv,ncol=1,dimnames=list(rownames(nyClose),"OBV")))
	
	#Making Example Data Frame
	Y=lag(return[,i],-1)

	dfpp=matrix(cbind(return[,i],subStat),ncol=2)
	
	for(j in c(2:nrow(dfpp))) {
		a=dfpp[j,2]; b=dfpp[j-1,2];
		
		if(is.na(b)==FALSE & is.na(a)==TRUE) {
			dfpp[j,2]=b
		}
	}
	
	#Stat
	sStatCov=as.timeSeries(matrix(dfpp[,2],ncol=1,dimnames=list(rownames(return),colnames(subStat))))
	
	dfPre=cbind(Y,sStatCov,Kst,Roc,Stoch,Obv)
	dfPre[nrow(dfPre),1]=0
	dfPre=dfPre[rowSums(is.na(dfPre))==0,]
	colnames(dfPre)=c(colnames(return)[i],colnames(sStatCov),"KST","ROC","STOCH","OBV")
	
	df[[i]]=dfPre
	dfTest[[i]]=dfPre[1:round(nrow(dfPre)*0.6),]
	dfVdn[[i]]=dfPre[(round(nrow(dfPre)*0.6)+1):nrow(dfPre),]		
} 
```

학습셋은 다음과 같다. 데이터의 구조는 테스트셋도 동일하다.

```{R}
head(dfTest[[1]])
```

이후 SVM 을 사용하여 모델링을 하도록 한다. 학습에 사용 될 feature의 quality는 좋지 않을 것이며 예측 정확율을 조금 향상 시키기 위해 종목 간 모멘텀을 추가 변수로 삽입하는 예시를 보여준다. 매일 예측하는 것을 가정하여 모델링 하였으므로 멀티쓰레딩을 통해 시간을 절약하자.


```{R}
###################
##Modeling
###################
RstList=as.list(rep(NA,n))

for(i in c(1:n)) {
	dTI=dfTest[[i]]; dVI=dfVdn[[i]];
	
	#Generating Dependant
	cl=makeCluster(mc <- getOption("cl.cores", 4))

	ignore=clusterEvalQ(cl, {
		library(fPortfolio)
		library(e1071)
	})

	clusterExport(cl=cl, varlist=c(
		"dTI","dVI","return"
	))

	GsimFunc=function(j) {
		LTdat=rbind(dTI[j:nrow(dTI),],dVI[1:j,])
		
		LearnDat=as.timeSeries(matrix(LTdat[1:(nrow(LTdat)-1),],ncol=ncol(LTdat),
			dimnames=list(rownames(LTdat)[1:(nrow(LTdat)-1)],colnames(dTI))))
		colnames(LearnDat)[1]="Dependent"	
		
		TestDat=as.timeSeries(matrix(LTdat[nrow(LTdat),],ncol=ncol(LTdat),
			dimnames=list(rownames(LTdat)[nrow(LTdat)],colnames(dTI))))
		colnames(TestDat)[1]="Dependent"
		
		#Add New Feature
		FL=cbind(LearnDat[,1],return)
		FL=FL[rowSums(is.na(FL))==0,]
		
		sFL=lapply(2:ncol(FL),function(k) {
			subModel=summary(lm(FL[,1]~FL[,k]))
			
			if(subModel$coefficient[2,4]<=0.1) {
				return(k)
			} else {
				return(NA)
			}
		})
		
		sFL=unlist(sFL[is.na(sFL)==FALSE])
		
		if(is.null(sFL)==FALSE) {
			LearnDat=as.timeSeries(cbind(LearnDat,FL[,sFL]))
			TestDat=as.timeSeries(cbind(TestDat,return[rownames(TestDat),colnames(FL[,sFL])]))
		}
		
		#Start!
		#tuned=try(tune.svm(Dependent~.,data=LearnDat,gamma=10^(-2:0),cost=10^(0:2)),silent=T)

		#if("try-error" %in% class(tuned)) {
		#	GammaCost=matrix(c(0.01,10),nrow=1,ncol=2)
		#} else {
		#	GammaCost=cbind(tuned$best.parameters$gamma,tuned$best.parameters$cost)
		#}

		#Model=try(svm(Dependent~.,data=LearnDat,gamma=GammaCost[,1],cost=GammaCost[,2]),silent=T)
		Model=try(svm(Dependent~.,data=LearnDat),silent=T)
		
		if("try-error" %in% class(Model)) {
			SvmPred=as.timeSeries(matrix(0,nrow=1,ncol=1,
				dimnames=list(rownames(TestDat),"Pred")))
		} else {
			SvmPred=as.timeSeries(predict(Model,TestDat[,-1]))
			colnames(SvmPred)="Pred"			
		}
	
		SubRst=cbind(TestDat[,1],SvmPred)
		return(SubRst)
	}
	
	GsimList=parLapply(cl,1:nrow(dVI),GsimFunc)
	stopCluster(cl)
	
	GsimMat=do.call(rbind,GsimList)
	colnames(GsimMat)=c(colnames(df[[i]])[1],"Pred")
	
	RstList[[i]]=GsimMat
}

RstList=RstList[is.na(RstList)==FALSE]

```

실제 결과와 예측값이 RstList라는 변수에 저장 되었다. 아래에서 첫번째 열은 실제 수익율이며 두번째 열을 예측 값이다. 방향성이 같으면 적중한 것이라 판단한다.

```{R}
head(RstList[[1]])
```

예측을 사용한 적중 정확율을 확인하도록 한다. 예측율은 51.8%로 random process에 가깝다.(garbage in garbage out)

```{R}
RstHit=lapply(RstList,function(x) {
	aX=matrix(x[-which(x[,1]==0 | x[,2]==0),],ncol=2)		
	A=mean(ifelse(aX[,1]*aX[,2]>0,1,0))
	
	return(A)
})

#Check Performance
A=mean(unlist(RstHit))
print(A)
```

다음으로 당일 상승할 것으로 예측 되는 종목을 가져와서 매수하기 위해 자산배분을 하는 예제를 담았다. 보통 mean variance portfolio를 사용하면 특정 종목 쏠림 현상이 나타나므로 resampled efficiency를 통해 자산배분을 시도한다. 본 예제에서는 단 100번만 하였다.(nSamp) 또한 아래에서는 종목 별 최소, 최대 가중치 제한를 둠으로써 사용자가 가중치를 일부 조정가능 하도록 코딩하였다.

```{R}
#Find Up Value
RstUp=lapply(RstList,function(x) {	
	A=as.numeric(x[nrow(x),2])
	
	if(A>0) { 
		return(colnames(x)[1])
	} else {
		return(NA)
	}
})

RstUp=unlist(RstUp[is.na(RstUp)==FALSE])


###################
##Resampled Efficiency
###################
nAA=nrow(dfTest[[1]])
RetAA=return[(nrow(return)-nAA+1):nrow(return),RstUp]

nSamp=100
ResMat=matrix(0,nrow=nSamp,ncol=ncol(RetAA),
	dimname=list(NULL,colnames(RetAA)))

for(i in c(1:nSamp)) {
	beRand=sort(sample(1:length(RstUp),min(5,length(RstUp))))
	RbR=RstUp[beRand]

	numAsset=length(beRand)
	minW=rep(0.01,numAsset)
	maxW=rep(1,numAsset)

	nAss=c(1:numAsset)
	constMin=paste("minW[", nAss, "]=", minW, sep="")
	constMax=paste("maxW[", nAss, "]=", maxW, sep="")
	constraints=c(constMin,constMax)
	
	MVP=minvariancePortfolio(RetAA[,RbR],spec=portfolioSpec(),constraints=constraints)
	gWmvp=getWeights(MVP)
	
	ResMat[i,names(gWmvp)]=gWmvp
}

reEffWeight=colMeans(ResMat)

saveRDS(reEffWeight,"C:/Git/Rds/reEffWeight.rds")
saveRDS(nyClose,"C:/Git/Rds/nyClose.rds")

```

배분된 종목 별 가중치는 아래와 같다.

```{R}
print(round(reEffWeight,3))
```

마지막으로 계좌 정보를 불러오고 주문을 내는 과정을 살펴보자.

```{R}

library(rcom)
library(fPortfolio)

obj=comCreateObject("XA_Session.XASession")
objQuery.t0424=comCreateObject("XA_DataSet.XAQuery")
objQuery.CSPAT00600=comCreateObject("XA_DataSet.XAQuery")


#######################
##Log In
#######################
comInvoke(obj,"DisconnectServer")
comInvoke(obj,"ConnectServer","demo.etrade.co.kr",20001)

ID="your ID"
PW1="your pwd"
AccNo="your account number"
AccPW="your acoount pwd"

Login=comInvoke(obj,"Login",ID,PW1,"",0,"False")

repeat {
	if(comInvoke(obj,"GetClientIP")=="") {
		Sys.sleep(1)
	} else {
		break
	}
}

Sys.sleep(5)


#######################
##Get Account
#######################
comInvoke(objQuery.t0424,"LoadFromResFile","C:/eBEST/xingAPI/Res/t0424.res")
comInvoke(objQuery.t0424,"SetFieldData","t0424InBlock", "accno", 0, AccNo) 
comInvoke(objQuery.t0424,"SetFieldData","t0424InBlock", "passwd", 0, AccPW) 
comInvoke(objQuery.t0424,"SetFieldData","t0424InBlock", "prcgb", 0, "1") 
comInvoke(objQuery.t0424,"SetFieldData","t0424InBlock", "chegb", 0, "2") 
comInvoke(objQuery.t0424,"SetFieldData","t0424InBlock", "dangb", 0, "0") 
comInvoke(objQuery.t0424,"SetFieldData","t0424InBlock", "charge", 0, "0") 
comInvoke(objQuery.t0424,"SetFieldData","t0424InBlock", "cts_expcode", 0, "") 

Sys.sleep(2)

DoCntA=0

repeat {
	comRqst=comInvoke(objQuery.t0424,"Request","FALSE")

	if(comRqst<0) {		
		Sys.sleep(2)

		comRqst=comInvoke(objQuery.t0424,"Request","FALSE")
	} else {
		break
	}
}

Sys.sleep(2)

repeat {
	IndivInvestPrice=comInvoke(objQuery.t0424,"GetFieldData","t0424OutBlock", "sunamt",0)
	IndivInvestPrice=as.numeric(IndivInvestPrice)

	if(is.na(IndivInvestPrice)==TRUE) {		
		Sys.sleep(2)

		IndivInvestPrice=comInvoke(objQuery.t0424,"GetFieldData","t0424OutBlock", "sunamt",0)
		IndivInvestPrice=as.numeric(IndivInvestPrice)
	} else {
		break
	}
}


#######################
##Ordering
#######################
OptW=readRDS("C:/Git/Rds/reEffWeight.rds")
nyClose=readRDS("C:/Git/Rds/nyClose.rds")

Tclose=nyClose[nrow(nyClose),names(OptW)]
StockInvPrice=as.numeric(OptW)*IndivInvestPrice
nVolume=ceiling(StockInvPrice/Tclose)
beZvol=which(nVolume==0)

if(is.null(beZvol)==TRUE) { 
	nVolume=nVolume[-beZvol] 
	Tclose=Tclose[-beZvol]
}

for(i in c(1:length(nVolume))) {
	comInvoke(objQuery.CSPAT00600,"LoadFromResFile","C:/eBEST/xingAPI/Res/CSPAT00600.res")
	
	comInvoke(objQuery.CSPAT00600,"SetFieldData","CSPAT00600InBlock1", "AcntNo", 0, AccNo)
	comInvoke(objQuery.CSPAT00600,"SetFieldData","CSPAT00600InBlock1", "InptPwd", 0, AccPW)
	comInvoke(objQuery.CSPAT00600,"SetFieldData","CSPAT00600InBlock1", "IsuNo", 0, paste("A",names(nVolume),sep=""))
	comInvoke(objQuery.CSPAT00600,"SetFieldData","CSPAT00600InBlock1", "OrdPrc", 0, Tclose[i])
	comInvoke(objQuery.CSPAT00600,"SetFieldData","CSPAT00600InBlock1", "OrdQty", 0, nVolume[i])
	comInvoke(objQuery.CSPAT00600,"SetFieldData","CSPAT00600InBlock1", "BnsTpCode", 0, 2) 
	comInvoke(objQuery.CSPAT00600,"SetFieldData","CSPAT00600InBlock1", "BnsTpCode", 0, "00") 
	comInvoke(objQuery.CSPAT00600,"SetFieldData","CSPAT00600InBlock1", "MgntrnCode", 0, "000")
	comInvoke(objQuery.CSPAT00600,"SetFieldData","CSPAT00600InBlock1", "LoanDt", 0, "")
	comInvoke(objQuery.CSPAT00600,"SetFieldData","CSPAT00600InBlock1", "OrdCndiTpCode", 0, "0")
	
	nSuccess=comInvoke(objQuery.CSPAT00600,"Request","FALSE")
	
	Sys.sleep(1)
	
	#reset
	comInvoke(objQuery.CSPAT00600,"SetFieldData","CSPAT00600InBlock1", "IsuNo", 0, "")
	comInvoke(objQuery.CSPAT00600,"SetFieldData","CSPAT00600InBlock1", "OrdPrc", 0, "")
	comInvoke(objQuery.CSPAT00600,"SetFieldData","CSPAT00600InBlock1", "OrdQty", 0, "")	
}

```

이상의 과정을 통해 간단히 데이터 수집, 저장, 클린징, 모델링, 자산배분, 주문까지 살펴 보았다. 좋은 성능을 가지는 모델을 만들기 위해서는 좋은 설명변수가 필요함을 보였고 각 과정에서 발생 할 수 있는 오류처리에 대한 예시를 보여줌으로써 프로그래밍에 참고 할 수 있도록 하였다. 



